<!DOCTYPE html><html><head>
      <title>Agent</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////home/yangx2/.cursor-server/extensions/shd101wyy.markdown-preview-enhanced-0.8.20-universal/crossnote/dependencies/katex/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="intelligent-building-agent---implementation-details">Intelligent Building Agent - Implementation Details </h1>
<blockquote>
<p>A comprehensive technical document describing the multi-agent architecture for urban microclimate analysis</p>
</blockquote>
<hr>
<h2 id="table-of-contents">Table of Contents </h2>
<ol>
<li><a href="#1-system-architecture-overview">System Architecture Overview</a></li>
<li><a href="#2-core-agent-intelligentbuildingagent">Core Agent: IntelligentBuildingAgent</a></li>
<li><a href="#3-langgraph-workflow-implementation">LangGraph Workflow Implementation</a></li>
<li><a href="#4-sub-agent-system">Sub-Agent System</a></li>
<li><a href="#5-parameter-management-system">Parameter Management System</a></li>
<li><a href="#6-weather-integration-nea-api">Weather Integration (NEA API)</a></li>
<li><a href="#7-llm-interaction--recording">LLM Interaction &amp; Recording</a></li>
<li><a href="#8-material-tuning-pipeline">Material Tuning Pipeline</a></li>
<li><a href="#9-data-structures--state-management">Data Structures &amp; State Management</a></li>
<li><a href="#10-solver-backends">Solver Backends</a></li>
<li><a href="#11-visualization-pipeline">Visualization Pipeline</a></li>
<li><a href="#12-configuration-system">Configuration System</a></li>
</ol>
<hr>
<h2 id="1-system-architecture-overview">1. System Architecture Overview </h2>
<h3 id="11-high-level-architecture">1.1 High-Level Architecture </h3>
<pre data-role="codeBlock" data-info="" class="language-text"><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                    IntelligentBuildingAgent (Orchestrator)                   │
│                         LangGraph State Machine                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌───────────┐ │
│  │    Intent    │───►│   Geometry   │───►│    Solver    │───►│  Result   │ │
│  │   Analyzer   │    │   Analyzer   │    │ Orchestrator │    │ Integrator│ │
│  └──────────────┘    └──────────────┘    └──────────────┘    └───────────┘ │
│        │                    │                   │                    │      │
│        ▼                    ▼                   ▼                    ▼      │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                        LLM (GPT-5.1)                                  │  │
│  │                   via LangChain ChatOpenAI                            │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                              Sub-Agents                                      │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐            │
│  │ STLAnalysis│  │  Building  │  │    CFD     │  │   Solar    │            │
│  │   Agent    │  │QueryAgent  │  │SolverAgent │  │SolverAgent │            │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘            │
│        │                │                │                │                 │
│        ▼                ▼                ▼                ▼                 │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                    coupled_UrGen_v1 Backend                           │  │
│  │              (CFD + Radiation Physics Simulation)                     │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                         Supporting Services                                  │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐                │
│  │ NEAWeather     │  │  LLMRecorder   │  │  Artifact      │                │
│  │ Client         │  │                │  │  Collector     │                │
│  └────────────────┘  └────────────────┘  └────────────────┘                │
└─────────────────────────────────────────────────────────────────────────────┘
</code></pre><h3 id="12-technology-stack">1.2 Technology Stack </h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Technology</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>LLM</td>
<td>OpenAI GPT-5.1</td>
<td>Natural language understanding &amp; generation</td>
</tr>
<tr>
<td>LLM Framework</td>
<td>LangChain</td>
<td>LLM abstraction and message handling</td>
</tr>
<tr>
<td>Workflow Engine</td>
<td>LangGraph</td>
<td>State machine-based agent orchestration</td>
</tr>
<tr>
<td>Observability</td>
<td>LangSmith</td>
<td>Tracing and debugging LLM calls</td>
</tr>
<tr>
<td>Physics Backend</td>
<td>coupled_UrGen_v1</td>
<td>CFD and radiation simulation</td>
</tr>
<tr>
<td>3D Processing</td>
<td>trimesh</td>
<td>STL geometry parsing and analysis</td>
</tr>
<tr>
<td>Visualization</td>
<td>matplotlib, vedo</td>
<td>Plot generation</td>
</tr>
<tr>
<td>Weather API</td>
<td><a href="http://data.gov.sg">data.gov.sg</a> (NEA)</td>
<td>Real-time weather data</td>
</tr>
</tbody>
</table>
<h3 id="13-file-structure">1.3 File Structure </h3>
<pre data-role="codeBlock" data-info="" class="language-text"><code>intelligent_agent_package/
├── intelligent_building_agent.py    # Main orchestrator agent
├── stl_agent.py                     # STL geometry analysis agent
├── query_agent.py                   # Building query Q&amp;A agent
├── weather_client.py                # NEA weather API client
├── llm_recorder.py                  # LLM interaction logging
├── config.py                        # API keys and configuration
├── solver_parameters.json           # Default solver parameters
├── full_analysis_with_recording_en.py  # Test runner with recording
│
├── wrapper/                         # Solver wrappers
│   ├── __init__.py
│   ├── cfd_solver.py               # CFD parameter adapter
│   ├── solar_solver.py             # Solar parameter adapter
│   └── artifact_utils.py           # Output file collection
│
└── coupled_UrGen_v1/               # Physics simulation backend
    ├── coupled_UrGen_.py           # Main simulation engine
    └── SGP_Singapore_486980_IWEC.csv  # IWEC weather data
</code></pre><hr>
<h2 id="2-core-agent-intelligentbuildingagent">2. Core Agent: IntelligentBuildingAgent </h2>
<h3 id="21-class-definition">2.1 Class Definition </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">IntelligentBuildingAgent</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Intelligent agent that understands user queries and automatically 
    calls appropriate solvers (CFD, Solar, Geometry analysis)
    """</span>
</code></pre><p><strong>Location</strong>: <code>intelligent_building_agent.py</code></p>
<h3 id="22-initialization">2.2 Initialization </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> api_key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> config_file<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> 
             allow_llm_params<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># LLM Setup</span>
    self<span class="token punctuation">.</span>llm <span class="token operator">=</span> ChatOpenAI<span class="token punctuation">(</span>
        api_key<span class="token operator">=</span>api_key<span class="token punctuation">,</span>
        model<span class="token operator">=</span><span class="token string">"gpt-5.1"</span><span class="token punctuation">,</span>
        temperature<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>
        service_tier<span class="token operator">=</span><span class="token string">"priority"</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># Sub-agents</span>
    self<span class="token punctuation">.</span>stl_agent <span class="token operator">=</span> STLAnalysisAgent<span class="token punctuation">(</span>api_key<span class="token operator">=</span>api_key<span class="token punctuation">,</span> recorder<span class="token operator">=</span>self<span class="token punctuation">.</span>llm_recorder<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>query_agent <span class="token operator">=</span> BuildingQueryAgent<span class="token punctuation">(</span>api_key<span class="token operator">=</span>api_key<span class="token punctuation">,</span> recorder<span class="token operator">=</span>self<span class="token punctuation">.</span>llm_recorder<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>cfd_agent <span class="token operator">=</span> CFDSolverAgent<span class="token punctuation">(</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>solar_agent <span class="token operator">=</span> SolarSolverAgent<span class="token punctuation">(</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>weather_client <span class="token operator">=</span> NEAWeatherClient<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># Configuration</span>
    self<span class="token punctuation">.</span>solver_config <span class="token operator">=</span> self<span class="token punctuation">.</span>_load_config<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-if">if</span> config_file <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    self<span class="token punctuation">.</span>allow_llm_params <span class="token operator">=</span> allow_llm_params  <span class="token comment"># Toggle LLM parameter suggestions</span>
    
    <span class="token comment"># Build workflow graph</span>
    self<span class="token punctuation">.</span>graph <span class="token operator">=</span> self<span class="token punctuation">.</span>_build_graph<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><h3 id="23-key-attributes">2.3 Key Attributes </h3>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>llm</code></td>
<td>ChatOpenAI</td>
<td>LangChain LLM interface</td>
</tr>
<tr>
<td><code>llm_recorder</code></td>
<td>LLMRecorder</td>
<td>Records all LLM interactions</td>
</tr>
<tr>
<td><code>stl_agent</code></td>
<td>STLAnalysisAgent</td>
<td>Geometry analysis sub-agent</td>
</tr>
<tr>
<td><code>query_agent</code></td>
<td>BuildingQueryAgent</td>
<td>Q&amp;A sub-agent</td>
</tr>
<tr>
<td><code>cfd_agent</code></td>
<td>CFDSolverAgent</td>
<td>CFD simulation wrapper</td>
</tr>
<tr>
<td><code>solar_agent</code></td>
<td>SolarSolverAgent</td>
<td>Solar simulation wrapper</td>
</tr>
<tr>
<td><code>weather_client</code></td>
<td>NEAWeatherClient</td>
<td>Live weather data fetcher</td>
</tr>
<tr>
<td><code>solver_config</code></td>
<td>Dict</td>
<td>Loaded JSON configuration</td>
</tr>
<tr>
<td><code>allow_llm_params</code></td>
<td>bool</td>
<td>Enable/disable LLM parameter suggestions</td>
</tr>
<tr>
<td><code>graph</code></td>
<td>StateGraph</td>
<td>Compiled LangGraph workflow</td>
</tr>
</tbody>
</table>
<h3 id="24-main-entry-point">2.4 Main Entry Point </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">analyze</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> stl_directory<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> 
            user_parameters<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
            output_directory<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Main analysis method - entry point for all building analysis requests
    
    Args:
        query: Natural language query from user
        stl_directory: Path to directory containing STL building files
        user_parameters: Optional override parameters for solvers
        output_directory: Optional custom output path
        
    Returns:
        Dictionary containing:
        - success: bool
        - response: str (LLM-generated analysis)
        - building_analysis: str (geometry insights)
        - solver_results: Dict (per-solver outputs)
        - output_files: Dict (generated file paths)
        - artifacts: Dict (all output artifacts)
        - error: str (error message if failed)
    """</span>
</code></pre><hr>
<h2 id="3-langgraph-workflow-implementation">3. LangGraph Workflow Implementation </h2>
<h3 id="31-workflow-graph-structure">3.1 Workflow Graph Structure </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">_build_graph</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> StateGraph<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Build LangGraph workflow"""</span>
    workflow <span class="token operator">=</span> StateGraph<span class="token punctuation">(</span>IntelligentAgentState<span class="token punctuation">)</span>
    
    <span class="token comment"># Add nodes (processing stages)</span>
    workflow<span class="token punctuation">.</span>add_node<span class="token punctuation">(</span><span class="token string">"intent_analyzer"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>_analyze_intent<span class="token punctuation">)</span>
    workflow<span class="token punctuation">.</span>add_node<span class="token punctuation">(</span><span class="token string">"geometry_analyzer"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>_run_geometry_analysis<span class="token punctuation">)</span>
    workflow<span class="token punctuation">.</span>add_node<span class="token punctuation">(</span><span class="token string">"solver_orchestrator"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>_run_solvers<span class="token punctuation">)</span>
    workflow<span class="token punctuation">.</span>add_node<span class="token punctuation">(</span><span class="token string">"result_integrator"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>_integrate_results<span class="token punctuation">)</span>
    workflow<span class="token punctuation">.</span>add_node<span class="token punctuation">(</span><span class="token string">"error_handler"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>_handle_error<span class="token punctuation">)</span>
    
    <span class="token comment"># Set entry point</span>
    workflow<span class="token punctuation">.</span>set_entry_point<span class="token punctuation">(</span><span class="token string">"intent_analyzer"</span><span class="token punctuation">)</span>
    
    <span class="token comment"># Add conditional edges</span>
    workflow<span class="token punctuation">.</span>add_conditional_edges<span class="token punctuation">(</span>
        <span class="token string">"intent_analyzer"</span><span class="token punctuation">,</span>
        self<span class="token punctuation">.</span>_check_intent_status<span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"success"</span><span class="token punctuation">:</span> <span class="token string">"geometry_analyzer"</span><span class="token punctuation">,</span> <span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"error_handler"</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    
    workflow<span class="token punctuation">.</span>add_conditional_edges<span class="token punctuation">(</span>
        <span class="token string">"geometry_analyzer"</span><span class="token punctuation">,</span>
        self<span class="token punctuation">.</span>_check_geometry_status<span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"success"</span><span class="token punctuation">:</span> <span class="token string">"solver_orchestrator"</span><span class="token punctuation">,</span> <span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"error_handler"</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    
    workflow<span class="token punctuation">.</span>add_conditional_edges<span class="token punctuation">(</span>
        <span class="token string">"solver_orchestrator"</span><span class="token punctuation">,</span>
        self<span class="token punctuation">.</span>_check_solver_status<span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"success"</span><span class="token punctuation">:</span> <span class="token string">"result_integrator"</span><span class="token punctuation">,</span> <span class="token string">"skip"</span><span class="token punctuation">:</span> <span class="token string">"result_integrator"</span><span class="token punctuation">,</span> <span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"error_handler"</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    
    workflow<span class="token punctuation">.</span>add_edge<span class="token punctuation">(</span><span class="token string">"result_integrator"</span><span class="token punctuation">,</span> END<span class="token punctuation">)</span>
    workflow<span class="token punctuation">.</span>add_edge<span class="token punctuation">(</span><span class="token string">"error_handler"</span><span class="token punctuation">,</span> END<span class="token punctuation">)</span>
    
    <span class="token keyword keyword-return">return</span> workflow<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><h3 id="32-workflow-diagram">3.2 Workflow Diagram </h3>
<pre data-role="codeBlock" data-info="" class="language-text"><code>                    ┌─────────────────┐
                    │      START      │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ Intent Analyzer │◄──── LLM: Determine required solvers
                    └────────┬────────┘      and suggest parameters
                             │
              ┌──────────────┼──────────────┐
              │ success      │              │ error
              ▼              │              ▼
     ┌─────────────────┐     │     ┌─────────────────┐
     │Geometry Analyzer│     │     │  Error Handler  │
     └────────┬────────┘     │     └────────┬────────┘
              │              │              │
              │ success      │              │
              ▼              │              │
     ┌─────────────────┐     │              │
     │Solver Orchestra.│     │              │
     └────────┬────────┘     │              │
              │              │              │
     ┌────────┼────────┐     │              │
     │success │  skip  │     │              │
     ▼        ▼        │     │              │
     ┌─────────────────┐     │              │
     │Result Integrator│◄────┘              │
     └────────┬────────┘                    │
              │                             │
              ▼                             ▼
                    ┌─────────────────┐
                    │       END       │
                    └─────────────────┘
</code></pre><h3 id="33-stage-details">3.3 Stage Details </h3>
<h4 id="stage-1-intent-analyzer-_analyze_intent">Stage 1: Intent Analyzer (<code>_analyze_intent</code>) </h4>
<p><strong>Purpose</strong>: Parse user query to determine which solvers are needed and extract initial parameters.</p>
<p><strong>LLM Prompt Structure</strong>:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>prompt <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"""Analyze this building analysis request and determine what solvers are needed.

User Query: "</span><span class="token interpolation"><span class="token punctuation">{</span>state<span class="token punctuation">.</span>request<span class="token punctuation">.</span>query<span class="token punctuation">}</span></span><span class="token string">"

Available Solvers:
1. geometry - Basic STL geometry analysis (always required first)
2. cfd - Wind flow, temperature, and humidity simulation
3. solar - Solar irradiance, shading, and Sky View Factor analysis
4. query - Answer specific questions about building orientation

Return JSON format:
{{
    "required_solvers": ["geometry", "cfd", ...],
    "parameters": {{
        "cfd": {{"wind_speed": 1.5, "wind_direction": 45, ...}},
        "solar": {{"time": "2025-12-21 14:00:00+08:00", "DNI": 800, ...}}
    }},
    "reasoning": "Why these solvers are needed..."
}}
"""</span></span>
</code></pre><p><strong>Output</strong>: Updates <code>state.required_solvers</code> and <code>state.solver_parameters</code></p>
<h4 id="stage-2-geometry-analyzer-_run_geometry_analysis">Stage 2: Geometry Analyzer (<code>_run_geometry_analysis</code>) </h4>
<p><strong>Purpose</strong>: Load and analyze STL building geometry files.</p>
<p><strong>Key Operations</strong>:</p>
<ol>
<li>Load all STL files from directory using <code>trimesh</code></li>
<li>Clean mesh (remove degenerate faces)</li>
<li>Extract building footprints and envelopes</li>
<li>Generate combined geometry file</li>
<li>Call <code>STLAnalysisAgent</code> for LLM-powered geometry insights</li>
<li>Generate top-view visualization with building IDs</li>
<li>Cache results for potential reuse</li>
</ol>
<p><strong>Output</strong>: Updates <code>state.building_analysis</code> and <code>state.solver_results["geometry"]</code></p>
<h4 id="stage-3-solver-orchestrator-_run_solvers">Stage 3: Solver Orchestrator (<code>_run_solvers</code>) </h4>
<p><strong>Purpose</strong>: Execute required physics solvers (CFD, Solar, Query).</p>
<p><strong>Parameter Priority System</strong> (lowest to highest):</p>
<ol>
<li>JSON config file (<code>solver_parameters.json</code>)</li>
<li>LLM suggestions (if <code>allow_llm_params=True</code>)</li>
<li>NEA live weather data (external API)</li>
<li>User parameters (highest priority override)</li>
</ol>
<p><strong>Solver Execution Flow</strong>:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-if">if</span> <span class="token string">"cfd"</span> <span class="token keyword keyword-in">in</span> state<span class="token punctuation">.</span>required_solvers<span class="token punctuation">:</span>
    <span class="token comment"># 1. Load from JSON config</span>
    <span class="token comment"># 2. Merge LLM suggestions (if enabled)</span>
    <span class="token comment"># 3. Apply NEA weather overrides</span>
    <span class="token comment"># 4. Apply user parameters</span>
    <span class="token comment"># 5. Execute CFD solver</span>
    cfd_result <span class="token operator">=</span> self<span class="token punctuation">.</span>cfd_agent<span class="token punctuation">.</span>run_analysis<span class="token punctuation">(</span>cfd_params<span class="token punctuation">)</span>

<span class="token keyword keyword-if">if</span> <span class="token string">"solar"</span> <span class="token keyword keyword-in">in</span> state<span class="token punctuation">.</span>required_solvers<span class="token punctuation">:</span>
    <span class="token comment"># Skip if CFD already ran coupled radiation</span>
    <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> state<span class="token punctuation">.</span>solver_results<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"cfd"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"coupled_run"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        solar_result <span class="token operator">=</span> self<span class="token punctuation">.</span>solar_agent<span class="token punctuation">.</span>run_analysis<span class="token punctuation">(</span>solar_params<span class="token punctuation">)</span>

<span class="token keyword keyword-if">if</span> <span class="token string">"query"</span> <span class="token keyword keyword-in">in</span> state<span class="token punctuation">.</span>required_solvers<span class="token punctuation">:</span>
    query_result <span class="token operator">=</span> self<span class="token punctuation">.</span>query_agent<span class="token punctuation">.</span>answer_query<span class="token punctuation">(</span>query<span class="token punctuation">,</span> building_analysis<span class="token punctuation">)</span>
</code></pre><h4 id="stage-4-result-integrator-_integrate_results">Stage 4: Result Integrator (<code>_integrate_results</code>) </h4>
<p><strong>Purpose</strong>: Combine all solver results and generate final LLM response.</p>
<p><strong>Key Operations</strong>:</p>
<ol>
<li>Sanitize solver results (remove large dataframes)</li>
<li>Extract analysis insights (hotspots, energy metrics)</li>
<li>Prepare summary with PET/MRT time buckets</li>
<li>Generate comprehensive LLM response with:
<ul>
<li>Direct answer to user query</li>
<li>Specific metrics citations</li>
<li>Visualization file references</li>
<li>Actionable recommendations</li>
</ul>
</li>
</ol>
<hr>
<h2 id="4-sub-agent-system">4. Sub-Agent System </h2>
<h3 id="41-stlanalysisagent">4.1 STLAnalysisAgent </h3>
<p><strong>Location</strong>: <code>stl_agent.py</code></p>
<p><strong>Purpose</strong>: Analyze 3D building geometry from STL files.</p>
<p><strong>Workflow (LangGraph)</strong>:</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>file_reader → content_analyzer → code_generator → code_executor
</code></pre><p><strong>State Definition</strong>:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">STLAnalysisState</span><span class="token punctuation">:</span>
    stl_file_path<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span>
    stl_content<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span>
    file_size<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span>
    analysis_result<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span>
    visualization_code<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span>
    output_path<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span>
    error_message<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span>
    stage<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"init"</span>
</code></pre><p><strong>Key Methods</strong>:</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_read_stl_file</code></td>
<td>Load STL (ASCII or binary via trimesh)</td>
</tr>
<tr>
<td><code>_analyze_stl_content</code></td>
<td>LLM analysis of geometry</td>
</tr>
<tr>
<td><code>_generate_visualization_code</code></td>
<td>LLM generates matplotlib code</td>
</tr>
<tr>
<td><code>_execute_visualization</code></td>
<td>Execute generated code to create PNG</td>
</tr>
<tr>
<td><code>analyze_stl</code></td>
<td>Main entry point</td>
</tr>
</tbody>
</table>
<h3 id="42-buildingqueryagent">4.2 BuildingQueryAgent </h3>
<p><strong>Location</strong>: <code>query_agent.py</code></p>
<p><strong>Purpose</strong>: Answer natural language questions about buildings (solar exposure, orientation, etc.)</p>
<p><strong>Workflow (LangGraph)</strong>:</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>query_processor → solar_analyzer → response_generator
</code></pre><p><strong>State Definition</strong>:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">BuildingQueryState</span><span class="token punctuation">:</span>
    building_analysis<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span>
    query<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span>
    location<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"Singapore"</span>
    season<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"winter"</span>
    time_of_day<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"afternoon"</span>
    building_side<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span>
    query_response<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span>
    confidence_score<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.0</span>
    reasoning<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span>
    error_message<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span>
    stage<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"init"</span>
</code></pre><p><strong>Key Features</strong>:</p>
<ul>
<li>Extracts parameters from query text (north/south/east/west, season, time)</li>
<li>Analyzes solar conditions for Singapore's tropical climate</li>
<li>Returns confidence score (0-100%)</li>
<li>Generates professional recommendations</li>
</ul>
<h3 id="43-cfdsolveragent">4.3 CFDSolverAgent </h3>
<p><strong>Location</strong>: <code>wrapper/cfd_solver.py</code></p>
<p><strong>Purpose</strong>: Thin wrapper that forwards CFD parameters to the coupled_UrGen_v1 backend.</p>
<p><strong>Parameter Structure</strong>:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">CFDParameters</span><span class="token punctuation">:</span>
    stl_directory<span class="token punctuation">:</span> <span class="token builtin">str</span>
    wind_direction_deg<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    u_inflow<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    z_slice<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">2.0</span>
    voxel_pitch<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">4.0</span>
    buffer_ratio<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.10</span>
    T2m_C<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    RH2m_percent<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    alpha_T<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">1.5</span>
    alpha_RH<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">8.0</span>
    building_radius<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">100.0</span>
    cfd_log_z0<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.5</span>
    simulation_time<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    weather_csv_path<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    output_dir<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    work_dir<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    dt_hours<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">1.0</span>
    vedo_display_mode<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"off"</span>
    <span class="token comment"># Material overrides (rad_albedo_*, rad_emissivity_*, etc.)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><p><strong>Key Behavior</strong>:</p>
<ul>
<li>Loads IWEC weather time series from CSV</li>
<li>Calls <code>main_coupled_run()</code> with <code>run_cfd=True, run_radiation=True</code></li>
<li>Collects output artifacts (VTK, PNG, CSV, logs)</li>
<li>Returns analysis metrics if available</li>
</ul>
<h3 id="44-solarsolveragent">4.4 SolarSolverAgent </h3>
<p><strong>Location</strong>: <code>wrapper/solar_solver.py</code></p>
<p><strong>Purpose</strong>: Thin wrapper for solar/radiation simulation.</p>
<p><strong>Parameter Structure</strong>:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">SolarParameters</span><span class="token punctuation">:</span>
    stl_directory<span class="token punctuation">:</span> <span class="token builtin">str</span>
    time_str<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    latitude<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">1.3521</span>          <span class="token comment"># Singapore default</span>
    longitude<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">103.8198</span>
    elevation<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">15.0</span>
    dni_peak<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    dhi_peak<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    rays_per_receiver<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">64</span>
    ground_buffer<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">20.0</span>
    ground_res<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">25.0</span>
    shading_threshold<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">5.0</span>
    emissivity_ground<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.95</span>
    emissivity_wall<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.92</span>
    emissivity_roof<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.9</span>
    dt_hours<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">1.0</span>
    output_dir<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    work_dir<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    weather_csv_path<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><hr>
<h2 id="5-parameter-management-system">5. Parameter Management System </h2>
<h3 id="51-parameter-priority-chain">5.1 Parameter Priority Chain </h3>
<p>The system implements a strict priority chain for parameter resolution:</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>Priority (lowest → highest):
┌─────────────────────────────────────────────────────────────┐
│ 1. JSON Config File (solver_parameters.json)                │
│    └─ Baseline defaults loaded at agent initialization      │
├─────────────────────────────────────────────────────────────┤
│ 2. LLM Suggestions (if allow_llm_params=True)               │
│    └─ GPT-5.1 suggests parameters based on query context    │
├─────────────────────────────────────────────────────────────┤
│ 3. NEA Live Weather (external_parameters)                   │
│    └─ Real-time weather from data.gov.sg API                │
├─────────────────────────────────────────────────────────────┤
│ 4. User Parameters (user_parameters dict)                   │
│    └─ Explicit overrides from API caller (highest priority) │
└─────────────────────────────────────────────────────────────┘
</code></pre><h3 id="52-parameter-merging-logic">5.2 Parameter Merging Logic </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># CFD Parameter Merging Example</span>
cfd_params_dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment"># 1. Load from JSON config</span>
<span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>solver_config<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"cfd"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    cfd_params_dict<span class="token punctuation">.</span>update<span class="token punctuation">(</span>self<span class="token punctuation">.</span>solver_config<span class="token punctuation">[</span><span class="token string">"cfd"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 2. Merge LLM suggestions (if enabled)</span>
<span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>allow_llm_params <span class="token keyword keyword-and">and</span> state<span class="token punctuation">.</span>solver_parameters<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"cfd"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-for">for</span> key<span class="token punctuation">,</span> val <span class="token keyword keyword-in">in</span> state<span class="token punctuation">.</span>solver_parameters<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"cfd"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-if">if</span> key <span class="token keyword keyword-in">in</span> <span class="token punctuation">(</span><span class="token string">"wind_speed"</span><span class="token punctuation">,</span> <span class="token string">"wind_direction"</span><span class="token punctuation">,</span> <span class="token string">"temperature"</span><span class="token punctuation">,</span> <span class="token string">"humidity"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> cfd_params_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token keyword keyword-is">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>  <span class="token comment"># Only if missing</span>
                cfd_params_dict<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val

<span class="token comment"># 3. Apply NEA weather (only where config/LLM didn't set)</span>
<span class="token keyword keyword-if">if</span> state<span class="token punctuation">.</span>external_parameters <span class="token keyword keyword-and">and</span> state<span class="token punctuation">.</span>external_parameters<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"cfd"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ext_cfd <span class="token operator">=</span> state<span class="token punctuation">.</span>external_parameters<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"cfd"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-for">for</span> key<span class="token punctuation">,</span> val <span class="token keyword keyword-in">in</span> ext_cfd<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-if">if</span> cfd_params_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token keyword keyword-is">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            cfd_params_dict<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val

<span class="token comment"># 4. Apply user parameters (highest priority)</span>
<span class="token keyword keyword-if">if</span> state<span class="token punctuation">.</span>request<span class="token punctuation">.</span>user_parameters<span class="token punctuation">:</span>
    cfd_params_dict<span class="token punctuation">.</span>update<span class="token punctuation">(</span>user_cfd_params<span class="token punctuation">)</span>
</code></pre><h3 id="53-parameter-tracking-files">5.3 Parameter Tracking Files </h3>
<p>The system saves parameter provenance at each stage:</p>
<table>
<thead>
<tr>
<th>File</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>llm_suggested_parameters.json</code></td>
<td>LLM-suggested parameters with reasoning</td>
</tr>
<tr>
<td><code>external_weather_snapshot.json</code></td>
<td>Raw NEA API response + derived parameters</td>
</tr>
<tr>
<td><code>final_cfd_parameters.json</code></td>
<td>Final merged CFD parameters with priority order</td>
</tr>
<tr>
<td><code>final_solar_parameters.json</code></td>
<td>Final merged solar parameters</td>
</tr>
</tbody>
</table>
<h3 id="54-iwec-weather-integration">5.4 IWEC Weather Integration </h3>
<p>The system uses IWEC (International Weather for Energy Calculations) time series:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># Default weather file</span>
<span class="token keyword keyword-def">def</span> <span class="token function">_default_weather_csv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Path<span class="token punctuation">:</span>
    <span class="token keyword keyword-return">return</span> Path<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>parent <span class="token operator">/</span> <span class="token string">"coupled_UrGen_v1"</span> <span class="token operator">/</span> <span class="token string">"SGP_Singapore_486980_IWEC.csv"</span>

<span class="token comment"># Time series columns loaded:</span>
<span class="token comment"># - Wind direction, Wind Speed</span>
<span class="token comment"># - Air Temperature, Relative Humidity</span>
<span class="token comment"># - Direct Normal Radiation (DNI)</span>
<span class="token comment"># - Diffuse Horizontal Radiation (DHI)</span>
</code></pre><hr>
<h2 id="6-weather-integration-nea-api">6. Weather Integration (NEA API) </h2>
<h3 id="61-neaweatherclient">6.1 NEAWeatherClient </h3>
<p><strong>Location</strong>: <code>weather_client.py</code></p>
<p><strong>Purpose</strong>: Fetch real-time or historical weather data from Singapore's NEA (<a href="http://data.gov.sg">data.gov.sg</a>).</p>
<h3 id="62-api-endpoints">6.2 API Endpoints </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>DATASET_ENDPOINTS <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"temperature"</span><span class="token punctuation">:</span> <span class="token string">"https://api.data.gov.sg/v1/environment/air-temperature"</span><span class="token punctuation">,</span>
    <span class="token string">"humidity"</span><span class="token punctuation">:</span> <span class="token string">"https://api.data.gov.sg/v1/environment/relative-humidity"</span><span class="token punctuation">,</span>
    <span class="token string">"wind_speed"</span><span class="token punctuation">:</span> <span class="token string">"https://api.data.gov.sg/v1/environment/wind-speed"</span><span class="token punctuation">,</span>
    <span class="token string">"wind_direction"</span><span class="token punctuation">:</span> <span class="token string">"https://api.data.gov.sg/v1/environment/wind-direction"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="63-key-methods">6.3 Key Methods </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">NEAWeatherClient</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">fetch_weather_snapshot</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> target_datetime<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>datetime<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Fetch metadata and readings near target_datetime (SGT).
        Returns snapshot with measurements from all stations.
        """</span>
        
    <span class="token keyword keyword-def">def</span> <span class="token function">build_solver_parameters</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> snapshot<span class="token punctuation">:</span> Dict<span class="token punctuation">,</span> target_lat<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span> target_lon<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Map snapshot measurements into solver parameter format.
        Uses nearest station if coordinates provided.
        
        Returns:
            {
                "cfd": {"wind_speed": ..., "wind_direction": ..., "temperature": ..., "humidity": ...},
                "solar": {"ambient_temperature": ..., "time": ...}
            }
        """</span>
</code></pre><h3 id="64-timestamp-resolution">6.4 Timestamp Resolution </h3>
<p>The agent resolves simulation timestamps in priority order:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">_infer_weather_datetime</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> AnalysisRequest<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>datetime<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token comment"># 1. Check user_parameters for explicit timestamp</span>
    <span class="token keyword keyword-if">if</span> request<span class="token punctuation">.</span>user_parameters<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> parse<span class="token punctuation">(</span>user_parameters<span class="token punctuation">[</span><span class="token string">"timestamp"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 2. Parse datetime from query text</span>
    <span class="token keyword keyword-if">if</span> date_pattern_found_in_query<span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> extracted_datetime
    
    <span class="token comment"># 3. Use LLM to infer timestamp</span>
    llm_dt <span class="token operator">=</span> self<span class="token punctuation">.</span>_llm_choose_datetime<span class="token punctuation">(</span>query<span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> llm_dt<span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> llm_dt
    
    <span class="token comment"># 4. Fall back to default scenario datetime</span>
    <span class="token keyword keyword-return">return</span> DEFAULT_SCENARIO_DATETIME  <span class="token comment"># 1989-12-22 15:00 SGT</span>
</code></pre><hr>
<h2 id="7-llm-interaction--recording">7. LLM Interaction &amp; Recording </h2>
<h3 id="71-llmrecorder">7.1 LLMRecorder </h3>
<p><strong>Location</strong>: <code>llm_recorder.py</code></p>
<p><strong>Purpose</strong>: Track all LLM prompts and responses for debugging and audit.</p>
<h3 id="72-data-structure">7.2 Data Structure </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">LLMRecorder</span><span class="token punctuation">:</span>
    log_path<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Path<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    verbose_log_path<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Path<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    session_timestamp<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    interactions<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">object</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> field<span class="token punctuation">(</span>default_factory<span class="token operator">=</span><span class="token builtin">list</span><span class="token punctuation">)</span>
</code></pre><h3 id="73-recording-format">7.3 Recording Format </h3>
<p><strong>JSON Log</strong> (<code>llm_interactions_*.json</code>):</p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"session_info"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"20251014_103000"</span><span class="token punctuation">,</span>
    <span class="token property">"total_interactions"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token property">"total_time"</span><span class="token operator">:</span> <span class="token number">180.5</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"interactions"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2025-10-14T10:30:00"</span><span class="token punctuation">,</span>
      <span class="token property">"stage"</span><span class="token operator">:</span> <span class="token string">"Intent Analysis"</span><span class="token punctuation">,</span>
      <span class="token property">"prompt"</span><span class="token operator">:</span> <span class="token string">"Analyze this building analysis request..."</span><span class="token punctuation">,</span>
      <span class="token property">"response"</span><span class="token operator">:</span> <span class="token string">"{\"required_solvers\": [\"geometry\", \"cfd\"]}"</span><span class="token punctuation">,</span>
      <span class="token property">"elapsed_time"</span><span class="token operator">:</span> <span class="token number">45.2</span><span class="token punctuation">,</span>
      <span class="token property">"prompt_length"</span><span class="token operator">:</span> <span class="token number">1099</span><span class="token punctuation">,</span>
      <span class="token property">"response_length"</span><span class="token operator">:</span> <span class="token number">1167</span><span class="token punctuation">,</span>
      <span class="token property">"metadata"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"agent"</span><span class="token operator">:</span> <span class="token string">"intelligent_building_agent"</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>Verbose Text Log</strong> (<code>llm_verbose_log_*.txt</code>):</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>[Stage] Intent Analysis @ 2025-10-14T10:30:00
[Prompt]
SystemMessage: You are an expert in building performance analysis.
HumanMessage: Analyze this building analysis request...

[Inference]
Why these solvers are needed...

[Response]
{"required_solvers": ["geometry", "cfd"], ...}
--------------------------------------------------------------------------------
</code></pre><h3 id="74-recording-integration">7.4 Recording Integration </h3>
<p>Each agent uses <code>_invoke_llm</code> or <code>_invoke_with_logging</code> to record interactions:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">_invoke_llm</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> stage<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> messages<span class="token punctuation">:</span> List<span class="token punctuation">[</span>BaseMessage<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Call the LLM and persist prompt/response metadata."""</span>
    start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    response <span class="token operator">=</span> self<span class="token punctuation">.</span>llm<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>messages<span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>llm_recorder<span class="token punctuation">:</span>
        prompt_text <span class="token operator">=</span> <span class="token string">"\n\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>
            <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>msg<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span> 
            <span class="token keyword keyword-for">for</span> msg <span class="token keyword keyword-in">in</span> messages
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>llm_recorder<span class="token punctuation">.</span>record<span class="token punctuation">(</span>
            stage<span class="token operator">=</span>stage<span class="token punctuation">,</span>
            prompt<span class="token operator">=</span>prompt_text<span class="token punctuation">,</span>
            response<span class="token operator">=</span>response<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
            elapsed_time<span class="token operator">=</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">,</span>
            metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"agent"</span><span class="token punctuation">:</span> <span class="token string">"intelligent_building_agent"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> response
</code></pre><hr>
<h2 id="8-material-tuning-pipeline">8. Material Tuning Pipeline </h2>
<h3 id="81-overview">8.1 Overview </h3>
<p>The material tuning pipeline enables automated optimization of building surface materials (albedo, emissivity) to improve thermal comfort and reduce cooling loads.</p>
<p><strong>Location</strong>: <code>full_analysis_with_recording_en.py</code> → <code>run_material_tuning_test()</code></p>
<h3 id="82-pipeline-flow">8.2 Pipeline Flow </h3>
<pre data-role="codeBlock" data-info="" class="language-text"><code>┌──────────────────────────────────────────────────────────────┐
│                   Material Tuning Pipeline                    │
├──────────────────────────────────────────────────────────────┤
│                                                               │
│  1. BASELINE PASS                                             │
│     └─► Run CFD+Solar with default materials                  │
│     └─► Collect baseline_metrics (cooling_kWh, PET hotspots)  │
│                                                               │
│  2. PROPOSAL GENERATION                                       │
│     └─► _propose_material_overrides(baseline_metrics)         │
│     └─► Increase albedo (roof: 0.72, wall: 0.55, ground: 0.25)│
│     └─► Maintain high emissivity (≥0.93)                      │
│     └─► Identify target buildings from hotspots               │
│                                                               │
│  3. TUNED PASS                                                │
│     └─► Run CFD+Solar with proposed materials                 │
│     └─► Reuse geometry/RT cache from baseline                 │
│     └─► Collect tuned_metrics                                 │
│                                                               │
│  4. COMPARISON                                                │
│     └─► _compare_material_runs(baseline, tuned)               │
│     └─► Calculate Δ cooling kWh, Δ PET max                    │
│     └─► Per-building delta analysis                           │
│                                                               │
└──────────────────────────────────────────────────────────────┘
</code></pre><h3 id="83-material-override-heuristics">8.3 Material Override Heuristics </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">_propose_material_overrides</span><span class="token punctuation">(</span>metrics<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> baseline_materials<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Heuristic: raise albedo on roofs/walls/ground and emissivity on roofs/walls."""</span>
    reco <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>baseline_materials<span class="token punctuation">)</span>
    
    <span class="token comment"># Boost reflectance to cut solar gains</span>
    reco<span class="token punctuation">[</span><span class="token string">"albedo_roof"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>baseline<span class="token punctuation">[</span><span class="token string">"albedo_roof"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.72</span><span class="token punctuation">)</span>   <span class="token comment"># Cool roof</span>
    reco<span class="token punctuation">[</span><span class="token string">"albedo_wall"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>baseline<span class="token punctuation">[</span><span class="token string">"albedo_wall"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.55</span><span class="token punctuation">)</span>   <span class="token comment"># Light façade</span>
    reco<span class="token punctuation">[</span><span class="token string">"albedo_ground"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>baseline<span class="token punctuation">[</span><span class="token string">"albedo_ground"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">)</span>  <span class="token comment"># Light pavers</span>
    
    <span class="token comment"># Maintain high emissivity for longwave release</span>
    reco<span class="token punctuation">[</span><span class="token string">"emissivity_roof"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>baseline<span class="token punctuation">[</span><span class="token string">"emissivity_roof"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.93</span><span class="token punctuation">)</span>
    reco<span class="token punctuation">[</span><span class="token string">"emissivity_wall"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>baseline<span class="token punctuation">[</span><span class="token string">"emissivity_wall"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.94</span><span class="token punctuation">)</span>
    
    <span class="token comment"># Identify target buildings from cooling load + hotspot analysis</span>
    targets <span class="token operator">=</span> _material_targets_from_metrics<span class="token punctuation">(</span>metrics<span class="token punctuation">)</span>
    
    <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
        <span class="token string">"materials"</span><span class="token punctuation">:</span> reco<span class="token punctuation">,</span>
        <span class="token string">"targets"</span><span class="token punctuation">:</span> targets<span class="token punctuation">,</span>
        <span class="token string">"rationale"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"material_selection"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><h3 id="84-output-files">8.4 Output Files </h3>
<table>
<thead>
<tr>
<th>File</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>material_tuning_plan.json</code></td>
<td>Proposed materials, targets, rationale</td>
</tr>
<tr>
<td><code>material_tuning_comparison.json</code></td>
<td>Before/after metrics delta</td>
</tr>
<tr>
<td><code>material_tuning_diff.txt</code></td>
<td>Human-readable diff summary</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="9-data-structures--state-management">9. Data Structures &amp; State Management </h2>
<h3 id="91-intelligentagentstate">9.1 IntelligentAgentState </h3>
<p><strong>Location</strong>: <code>intelligent_building_agent.py</code></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">IntelligentAgentState</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""State for intelligent agent workflow"""</span>
    request<span class="token punctuation">:</span> AnalysisRequest <span class="token operator">=</span> <span class="token boolean">None</span>
    building_analysis<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span>
    required_solvers<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>      <span class="token comment"># ['geometry', 'cfd', 'solar', 'query']</span>
    solver_parameters<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span> <span class="token comment"># LLM-suggested params</span>
    solver_results<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>    <span class="token comment"># Results from each solver</span>
    external_parameters<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># NEA weather-derived params</span>
    weather_snapshot<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Raw NEA API response</span>
    final_response<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span>
    error_message<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span>
    output_directory<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span>
    stage<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"init"</span>  <span class="token comment"># init → intent_analysis → geometry → solvers → integration → complete</span>
    llm_log_file<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span>
    llm_text_log_file<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span>
    runnable_config<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>RunnableConfig<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    resolved_time<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>      <span class="token comment"># ISO timestamp for simulation</span>
</code></pre><h3 id="92-analysisrequest">9.2 AnalysisRequest </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">AnalysisRequest</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""User's analysis request"""</span>
    query<span class="token punctuation">:</span> <span class="token builtin">str</span>
    stl_directory<span class="token punctuation">:</span> <span class="token builtin">str</span>
    user_parameters<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
</code></pre><h3 id="93-solver-result-structure">9.3 Solver Result Structure </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># Example solver_results["cfd"]</span>
<span class="token punctuation">{</span>
    <span class="token string">"success"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token string">"backend"</span><span class="token punctuation">:</span> <span class="token string">"coupled_UrGen_v1"</span><span class="token punctuation">,</span>
    <span class="token string">"mode"</span><span class="token punctuation">:</span> <span class="token string">"cfd"</span><span class="token punctuation">,</span>
    <span class="token string">"output_directory"</span><span class="token punctuation">:</span> <span class="token string">"/path/to/output"</span><span class="token punctuation">,</span>
    <span class="token string">"work_directory"</span><span class="token punctuation">:</span> <span class="token string">"/path/to/rt_cache"</span><span class="token punctuation">,</span>
    <span class="token string">"parameters"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment"># CFDParameters as dict</span>
    <span class="token string">"artifacts"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"screenshots"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"vtk_files"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"data_files"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"log_files"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"all_files"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"visualization_files"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"data_files"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"analysis_metrics"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"cooling_energy"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"total_kWh"</span><span class="token punctuation">:</span> <span class="token number">1234.5</span><span class="token punctuation">,</span>
            <span class="token string">"per_building_kWh"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"b000"</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">"b001"</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"per_building_max_hourly_kw"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"ground_hotspots"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token string">"pet_c"</span><span class="token punctuation">:</span> <span class="token number">42.5</span><span class="token punctuation">,</span>
                <span class="token string">"location"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token number">20.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"time"</span><span class="token punctuation">:</span> <span class="token string">"15:00"</span><span class="token punctuation">,</span>
                <span class="token string">"nearest_buildings"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"b005"</span><span class="token punctuation">,</span> <span class="token string">"b006"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"meteorology"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"wind_speed_ms"</span><span class="token punctuation">:</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token string">"dni"</span><span class="token punctuation">:</span> <span class="token number">800</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"pet_time_summary"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"mrt_time_summary"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"pet_time_buckets"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"morning"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"noon"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"afternoon"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"evening"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"coupled_run"</span><span class="token punctuation">:</span> <span class="token boolean">True</span>
<span class="token punctuation">}</span>
</code></pre><hr>
<h2 id="10-solver-backends">10. Solver Backends </h2>
<h3 id="101-coupled_urgen_v1">10.1 coupled_UrGen_v1 </h3>
<p><strong>Location</strong>: <code>coupled_UrGen_v1/coupled_UrGen_.py</code></p>
<p><strong>Purpose</strong>: High-fidelity coupled CFD + radiation simulation engine.</p>
<p><strong>Key Function</strong>:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">main_coupled_run</span><span class="token punctuation">(</span>
    sim_year<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    sim_month<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    sim_day<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    dt_hours<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span>
    common_stl_dir<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    weather_csv_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    work_dir<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    output_dir<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    wind_dir_override<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    wind_speed_override<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    air_temp_override<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    rh_override<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    run_cfd<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    run_radiation<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    vedo_display_mode<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"off"</span><span class="token punctuation">,</span>
    <span class="token comment"># ... material parameters ...</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Main entry point for coupled CFD + radiation simulation.
    
    Outputs:
    - VTK files: PET, MRT, wind speed, temperature fields
    - PNG: Visualization screenshots
    - CSV: Building summaries, receptor data
    - JSON: analysis_metrics.json with aggregated results
    """</span>
</code></pre><h3 id="102-output-artifacts">10.2 Output Artifacts </h3>
<pre data-role="codeBlock" data-info="" class="language-text"><code>output_dir/
├── vtk_files/
│   ├── pet_on_mesh_0900.vtk
│   ├── pet_on_mesh_1200.vtk
│   ├── pet_on_mesh_1500.vtk
│   ├── mrt_on_mesh_*.vtk
│   └── ...
├── screenshots/
│   ├── cfd_field_summary.png
│   └── cfd_distributions.png
├── data/
│   ├── receptors_field.csv
│   └── building_wind_summary.csv
├── analysis_metrics.json
├── iwec_time_series_used.json
└── run.log
</code></pre><hr>
<h2 id="11-visualization-pipeline">11. Visualization Pipeline </h2>
<h3 id="111-geometry-visualizations">11.1 Geometry Visualizations </h3>
<p><strong>Top View with Building IDs</strong>:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">_generate_topview_with_ids</span><span class="token punctuation">(</span>
    footprints<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    output_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    title<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"Top View with Building IDs"</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Render a top-view plot with building footprints and ID labels.
    Uses matplotlib Rectangle patches for each building.
    """</span>
</code></pre><p><strong>STL Agent Orthographic Views</strong>:</p>
<ul>
<li>Generated by LLM-produced matplotlib code</li>
<li>Front view (XZ), Side view (YZ), Top view (XY)</li>
</ul>
<h3 id="112-cfd-visualizations">11.2 CFD Visualizations </h3>
<table>
<thead>
<tr>
<th>File</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>cfd_field_summary.png</code></td>
<td>3-panel heatmap (wind speed, temperature, humidity)</td>
</tr>
<tr>
<td><code>cfd_distributions.png</code></td>
<td>Histograms for each field</td>
</tr>
</tbody>
</table>
<h3 id="113-solar-visualizations">11.3 Solar Visualizations </h3>
<table>
<thead>
<tr>
<th>File</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>solar_surface_snapshot.png</code></td>
<td>Scatter plot colored by shortwave flux</td>
</tr>
<tr>
<td><code>solar_surface_heatmap.png</code></td>
<td>Gridded heatmap with building masks</td>
</tr>
<tr>
<td><code>solar_building_summary.png</code></td>
<td>Bar charts per building</td>
</tr>
</tbody>
</table>
<h3 id="114-petmrt-time-buckets">11.4 PET/MRT Time Buckets </h3>
<p>The system summarizes thermal comfort indices across the simulation day:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">_bucket_time_summary</span><span class="token punctuation">(</span>summaries<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Bucket time summaries into morning/noon/afternoon/evening.
    
    Returns:
        {
            "morning": {"time_token": "0900", "max_value": 38.5, "location": [...], "building_id": "b005"},
            "noon": {...},
            "afternoon": {...},
            "evening": {...}
        }
    """</span>
</code></pre><hr>
<h2 id="12-configuration-system">12. Configuration System </h2>
<h3 id="121-configpy">12.1 <a href="http://config.py">config.py</a> </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># Required</span>
OPENAI_API_KEY <span class="token operator">=</span> <span class="token string">"sk-..."</span>

<span class="token comment"># LangSmith Observability</span>
LANGSMITH_API_KEY <span class="token operator">=</span> <span class="token string">"lsv2_..."</span>
LANGSMITH_ENDPOINT <span class="token operator">=</span> <span class="token string">"https://api.smith.langchain.com"</span>
LANGSMITH_PROJECT <span class="token operator">=</span> <span class="token string">"IntelligentBuildingAgent"</span>

<span class="token comment"># Model Configuration</span>
DEFAULT_MODEL <span class="token operator">=</span> <span class="token string">"GPT-5.1"</span>
TEMPERATURE <span class="token operator">=</span> <span class="token number">0.1</span>
</code></pre><h3 id="122-solver_parametersjson">12.2 solver_parameters.json </h3>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"cfd"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"wind_speed"</span><span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token property">"wind_direction"</span><span class="token operator">:</span> <span class="token number">45.0</span><span class="token punctuation">,</span>
    <span class="token property">"height"</span><span class="token operator">:</span> <span class="token number">2.0</span><span class="token punctuation">,</span>
    <span class="token property">"temperature"</span><span class="token operator">:</span> <span class="token number">30.0</span><span class="token punctuation">,</span>
    <span class="token property">"humidity"</span><span class="token operator">:</span> <span class="token number">70.0</span><span class="token punctuation">,</span>
    <span class="token property">"voxel_pitch"</span><span class="token operator">:</span> <span class="token number">4.0</span><span class="token punctuation">,</span>
    <span class="token property">"buffer_ratio"</span><span class="token operator">:</span> <span class="token number">0.10</span><span class="token punctuation">,</span>
    <span class="token property">"alpha_t"</span><span class="token operator">:</span> <span class="token number">1.5</span><span class="token punctuation">,</span>
    <span class="token property">"alpha_rh"</span><span class="token operator">:</span> <span class="token number">8.0</span><span class="token punctuation">,</span>
    <span class="token property">"building_radius"</span><span class="token operator">:</span> <span class="token number">100.0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"solar"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"time"</span><span class="token operator">:</span> <span class="token string">"2025-10-04 14:00:00+08:00"</span><span class="token punctuation">,</span>
    <span class="token property">"latitude"</span><span class="token operator">:</span> <span class="token number">1.3521</span><span class="token punctuation">,</span>
    <span class="token property">"longitude"</span><span class="token operator">:</span> <span class="token number">103.8198</span><span class="token punctuation">,</span>
    <span class="token property">"elevation"</span><span class="token operator">:</span> <span class="token number">15.0</span><span class="token punctuation">,</span>
    <span class="token property">"DNI"</span><span class="token operator">:</span> <span class="token number">800.0</span><span class="token punctuation">,</span>
    <span class="token property">"DHI"</span><span class="token operator">:</span> <span class="token number">180.0</span><span class="token punctuation">,</span>
    <span class="token property">"rays_per_receiver"</span><span class="token operator">:</span> <span class="token number">64</span><span class="token punctuation">,</span>
    <span class="token property">"ground_buffer"</span><span class="token operator">:</span> <span class="token number">20.0</span><span class="token punctuation">,</span>
    <span class="token property">"ground_res"</span><span class="token operator">:</span> <span class="token number">25.0</span><span class="token punctuation">,</span>
    <span class="token property">"receiver_offset"</span><span class="token operator">:</span> <span class="token number">0.1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="123-cli-options">12.3 CLI Options </h3>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>python full_analysis_with_recording_en.py <span class="token punctuation">\</span>
    <span class="token parameter variable">--config</span> solver_parameters.json <span class="token punctuation">\</span>        <span class="token comment"># Custom config file</span>
    --no-llm-params <span class="token punctuation">\</span>                        <span class="token comment"># Disable LLM suggestions</span>
    --stl-directory /path/to/stl <span class="token punctuation">\</span>           <span class="token comment"># STL file location</span>
    <span class="token parameter variable">--tests</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">5</span> <span class="token punctuation">\</span>                          <span class="token comment"># Run specific tests</span>
    --material-tuning                        <span class="token comment"># Enable material optimization</span>
</code></pre><hr>
<h2 id="appendix-a-seasonal-test-definitions">Appendix A: Seasonal Test Definitions </h2>
<table>
<thead>
<tr>
<th>Test</th>
<th>Scenario</th>
<th>Key Parameters</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>NE Monsoon Wet Phase (Dec)</td>
<td>Wind: 12 m/s @ 25°, T=26°C, RH=92%</td>
</tr>
<tr>
<td>2</td>
<td>NE Monsoon Dry Phase (Feb)</td>
<td>DNI=850, DHI=110, Wind: 7 m/s @ 35°</td>
</tr>
<tr>
<td>3</td>
<td>Inter-monsoon (Apr)</td>
<td>T=32°C, RH=75%, Variable winds</td>
</tr>
<tr>
<td>4</td>
<td>SW Monsoon Sumatra Squall (Jul)</td>
<td>Wind: 17 m/s @ 190°, T=28°C</td>
</tr>
<tr>
<td>5</td>
<td>Fully Coupled Audit</td>
<td>Combined CFD+Solar, April conditions</td>
</tr>
<tr>
<td>5m</td>
<td>Material Tuning Loop</td>
<td>Test 5 + baseline/tuned comparison</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="appendix-b-key-dependencies">Appendix B: Key Dependencies </h2>
<pre data-role="codeBlock" data-info="" class="language-text"><code>langchain-openai&gt;=0.1.0
langgraph&gt;=0.0.1
langsmith&gt;=0.0.1
openai&gt;=1.0.0
numpy&gt;=1.24.0
pandas&gt;=2.0.0
matplotlib&gt;=3.7.0
trimesh&gt;=4.0.0
scipy&gt;=1.10.0
pvlib&gt;=0.10.0
requests&gt;=2.31.0
</code></pre><hr>
<h2 id="appendix-c-error-handling">Appendix C: Error Handling </h2>
<p>The system implements comprehensive error handling:</p>
<ol>
<li><strong>Stage-level error routing</strong>: Each LangGraph node can route to <code>error_handler</code></li>
<li><strong>Solver graceful degradation</strong>: Failed solvers return <code>{"success": False, "error": ...}</code></li>
<li><strong>Parameter validation</strong>: Invalid JSON configs are caught at load time</li>
<li><strong>Weather API fallback</strong>: NEA fetch failures use IWEC defaults</li>
<li><strong>LLM parsing recovery</strong>: Malformed LLM JSON responses trigger fallback logic</li>
</ol>
<hr>
<p><em>Document Version: 1.0</em><br>
<em>Last Updated: January 2026</em><br>
*Author: Xinyu Yang</p>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>